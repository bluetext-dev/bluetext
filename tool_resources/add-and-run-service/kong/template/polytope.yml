tools:
  {{ project-name }}:
    info: "Runs the Kong API Gateway"
    await: [load-config]
    run:
      - tool: polytope/kong!simple
        args:
          id: {{ project-name }}
          image: gcr.io/arched-inkwell-420116/kong-oauth-proxy:latest
          config-file: { type: repo, path: /config/{{ project-name }}/kong.yml }
          autoreload: true
          restart: { policy: always }
          create: when-missing
          env:
            - { name: KONG_ADMIN_LISTEN, value: "0.0.0.0:{pt.value {{ project-name }}-admin-port}" }
            - { name: KONG_PROXY_LISTEN, value: "0.0.0.0:{pt.value {{ project-name }}-proxy-port}" }
            - { name: KONG_NGINX_HTTP_LUA_SHARED_DICT, value: 'phantom-token 10m' }
            - { name: KONG_PLUGINS, value: 'bundled,oauth-proxy,phantom-token' }
          plugins:
            - { name: phantom-token, package: kong-phantom-token, version: 2.0.0 }

          services:
            - { id: {{ project-name }}, ports: [{ port: "{pt.value {{ project-name }}-proxy-port}", protocol: http, expose-as: "{pt.value {{ project-name }}-proxy-port}" }] }
            - { id: {{ project-name }}-admin, ports: [{ port: "{pt.value {{ project-name }}-admin-port}", protocol: http, expose-as: "{pt.value {{ project-name }}-admin-port}" }] }

