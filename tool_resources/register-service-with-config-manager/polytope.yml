tools:
  register-service-with-config-manager:
    info: |
      Registers a database server with the service-config-manager.
      Adds the service to managed-services.yaml and injects credentials into the config manager's environment.
    inputs:
      service:
        info: Service name to register (e.g., "auth-db")
        type: str
      type:
        info: Server type (couchbase or postgres)
        type: [enum, couchbase, postgres]
      host:
        info: Hostname of the service (defaults to service name)
        type: [default, str, ""]
      username:
        info: Username for the service
        type: [default, str, ""]
      password:
        info: Password for the service
        type: [default, str, ""]
      database:
        info: Database name (for postgres)
        type: [default, str, ""]
    run:
      - id: register-service
        code: |-
          pt.js
          var serviceName = pt.param("service").toLowerCase().replace(/[^a-z0-9_-]/g, "-");
          var serverType = pt.param("type");
          var host = pt.param("host") || serviceName;
          var username = pt.param("username");
          var password = pt.param("password");
          var database = pt.param("database");

          if (!username) username = serverType === "couchbase" ? "Administrator" : "postgres";
          if (!password) password = "password";
          if (!database && serverType === "postgres") database = "postgres";

          var script = [
            "import yaml",
            "from pathlib import Path",
            "import sys",
            "import os",
            "",
            "service_name = '" + serviceName + "'",
            "server_type = '" + serverType + "'",
            "host = '" + host + "'",
            "username = '" + username + "'",
            "password = '" + password + "'",
            "database = '" + database + "'",
            "",
            "config_manager_service = 'service-config-manager'",
            "config_manager_polytope = Path('/repo/services/' + config_manager_service + '/polytope.yml')",
            "",
            "if not config_manager_polytope.exists():",
            "    print('ERROR: service-config-manager not found. Add one first with add-and-run-service.')",
            "    sys.exit(1)",
            "",
            "print('Found config manager: ' + config_manager_service)",
            "",
            "# 1. Update managed-services.yaml",
            "managed_services_path = Path('/repo/config/' + config_manager_service + '/managed-services.yaml')",
            "if not managed_services_path.exists():",
            "    print('WARNING: ' + str(managed_services_path) + ' not found. Creating it.')",
            "    managed_services_path.parent.mkdir(parents=True, exist_ok=True)",
            "    managed_services = []",
            "else:",
            "    with open(managed_services_path) as f:",
            "        managed_services = yaml.safe_load(f) or []",
            "",
            "existing_service = next((s for s in managed_services if s['name'] == service_name), None)",
            "if existing_service:",
            "    print('Service ' + service_name + ' already registered in managed-services.yaml')",
            "else:",
            "    new_service = {'name': service_name, 'type': server_type, 'config_dir': service_name}",
            "    managed_services.append(new_service)",
            "    with open(managed_services_path, 'w') as f:",
            "        yaml.dump(managed_services, f, default_flow_style=False, sort_keys=False)",
            "    print('Added ' + service_name + ' to managed-services.yaml')",
            "",
            "# 2. Update polytope.yml (Env Vars)",
            "with open(config_manager_polytope) as f:",
            "    cm_config = yaml.safe_load(f) or {}",
            "",
            "cm_tools = cm_config.get('tools', {})",
            "cm_tool = cm_tools.get(config_manager_service, {})",
            "run_steps = cm_tool.get('run', [])",
            "",
            "env_vars_added = False",
            "for step in run_steps:",
            "    args = step.get('args', {}) if isinstance(step, dict) else {}",
            "    if 'env' not in args:",
            "        continue",
            "    env = args['env']",
            "    prefix = service_name.upper().replace('-', '_')",
            "    new_vars = [",
            "        {'name': prefix + '_HOST', 'value': 'pt.value ' + service_name + '-host'},",
            "        {'name': prefix + '_USERNAME', 'value': 'pt.value ' + service_name + '-username'},",
            "        {'name': prefix + '_PASSWORD', 'value': 'pt.secret ' + service_name + '-password'},",
            "    ]",
            "    if server_type == 'postgres':",
            "        new_vars.append({'name': prefix + '_DB', 'value': 'pt.value ' + service_name + '-database'})",
            "    for var in new_vars:",
            "        if not any(e['name'] == var['name'] for e in env):",
            "            env.append(var)",
            "            env_vars_added = True",
            "            print('Added env var: ' + var['name'])",
            "    args['env'] = env",
            "",
            "if env_vars_added:",
            "    with open(config_manager_polytope, 'w') as f:",
            "        yaml.dump(cm_config, f, default_flow_style=False, sort_keys=False)",
            "    print('Updated ' + config_manager_service + '/polytope.yml with new env vars')",
            "else:",
            "    print('Env vars already exist')",
            "",
            "# 3. Create default config file",
            "config_dir = Path('/repo/config/' + service_name)",
            "config_dir.mkdir(parents=True, exist_ok=True)",
            "",
            "if server_type == 'couchbase':",
            "    config_file = config_dir / 'couchbase.yaml'",
            "    if not config_file.exists():",
            "        with open(config_file, 'w') as f:",
            "            f.write('# Couchbase Configuration\\nbuckets:\\n  default:\\n    ram_quota_mb: 100\\n')",
            "        print('Created default config: ' + str(config_file))",
            "elif server_type == 'postgres':",
            "    config_file = config_dir / 'postgres.sql'",
            "    if not config_file.exists():",
            "        with open(config_file, 'w') as f:",
            "            f.write('-- Postgres Configuration\\nSELECT 1;\\n')",
            "        print('Created default config: ' + str(config_file))",
          ].join("\n");

          pt.callModule("pt/run-script", {
            repo: { type: "host", path: "." },
            language: "python",
            dependencies: ["pyyaml"],
            script: { type: "string", data: script }
          });

      - id: reapply-config-manager
        after: {step: register-service}
        code: |-
          pt.js
          pt.log("Reapplying service-config-manager to pick up new configuration...");
          pt.callModule("service-config-manager", {});
